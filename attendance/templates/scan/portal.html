{% extends 'base.html' %}

{% block title %}QR Scan Portal{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-800">QR Scan Portal</h1>
        <p class="text-gray-600 mt-2">Scan student QR codes to record attendance</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Scanner Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Scanner</h2>

            <!-- Subject Selection -->
            <div class="mb-4">
                <label for="subject-select" class="block text-sm font-medium text-gray-700 mb-2">
                    Select Subject
                </label>
                <select id="subject-select"
                    class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="">-- Select a subject --</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">
                        {{ subject.code }} - {{ subject.name }} (Grade {{ subject.grade_level }} {{ subject.section }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- QR Scanner -->
            <div id="reader" class="border-2 border-gray-300 rounded-lg mb-4" style="width: 100%;"></div>

            <!-- Scanner Controls -->
            <div class="flex gap-2">
                <button id="start-scan-btn"
                    class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    onclick="startScanner()">
                    Start Scanner
                </button>
                <button id="stop-scan-btn"
                    class="flex-1 bg-rose-500 hover:bg-rose-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors hidden"
                    onclick="stopScanner()">
                    Stop Scanner
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Scan Results</h2>

            <!-- Status Message -->
            <div id="status-message" class="hidden mb-4 p-4 rounded-lg"></div>

            <!-- Recent Scans -->
            <div id="recent-scans" class="space-y-3">
                <p class="text-gray-500 text-center py-8">No scans yet. Start scanning to see results.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    let html5QrCode = null;
    let isScanning = false;

    function startScanner() {
        const subjectId = document.getElementById('subject-select').value;

        if (!subjectId) {
            showStatus('error', 'Please select a subject first');
            return;
        }

        const startBtn = document.getElementById('start-scan-btn');
        const stopBtn = document.getElementById('stop-scan-btn');

        html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
            { facingMode: "environment" },
            {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            },
            onScanSuccess,
            onScanFailure
        ).then(() => {
            isScanning = true;
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            showStatus('info', 'Scanner active. Point camera at QR code.');
        }).catch(err => {
            showStatus('error', `Unable to start scanner: ${err}`);
        });
    }

    function stopScanner() {
        if (html5QrCode && isScanning) {
            html5QrCode.stop().then(() => {
                isScanning = false;
                const startBtn = document.getElementById('start-scan-btn');
                const stopBtn = document.getElementById('stop-scan-btn');
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                showStatus('info', 'Scanner stopped');
            });
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        const subjectId = document.getElementById('subject-select').value;

        // Stop scanner temporarily to prevent multiple scans
        if (isScanning) {
            stopScanner();
        }

        // Try to get geolocation
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    sendScanData(decodedText, subjectId, {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    });
                },
                (error) => {
                    console.warn("Geolocation failed:", error.message);
                    // Still send scan even if geolocation fails, but with null location
                    sendScanData(decodedText, subjectId, null);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            sendScanData(decodedText, subjectId, null);
        }
    }

    function sendScanData(uuid, subjectId, locationData) {
        // Send to server for verification
        fetch('{% url "verify_scan" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                uuid: uuid,
                subject_id: subjectId,
                location_data: locationData
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('success', data.message);
                    addRecentScan(data.data);
                } else {
                    showStatus('error', data.message);
                }
            })
            .catch(error => {
                showStatus('error', 'Network error. Please try again.');
            });
    }

    function onScanFailure(error) {
        // Ignore scan failures (happens when no QR code is in view)
    }

    function showStatus(type, message) {
        const statusDiv = document.getElementById('status-message');
        statusDiv.classList.remove('hidden', 'bg-emerald-100', 'text-emerald-800', 'bg-rose-100', 'text-rose-800', 'bg-blue-100', 'text-blue-800');

        if (type === 'success') {
            statusDiv.classList.add('bg-emerald-100', 'text-emerald-800');
        } else if (type === 'error') {
            statusDiv.classList.add('bg-rose-100', 'text-rose-800');
        } else {
            statusDiv.classList.add('bg-blue-100', 'text-blue-800');
        }

        statusDiv.textContent = message;
        statusDiv.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            statusDiv.classList.add('hidden');
        }, 5000);
    }

    function addRecentScan(data) {
        const recentScans = document.getElementById('recent-scans');

        // Clear "no scans" message
        if (recentScans.querySelector('p')) {
            recentScans.innerHTML = '';
        }

        const scanItem = document.createElement('div');
        scanItem.className = 'border-l-4 border-emerald-500 bg-emerald-50 p-4 rounded';
        scanItem.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <p class="font-semibold text-slate-800">${data.student_name}</p>
                <p class="text-sm text-gray-600">ID: ${data.student_id} | Grade ${data.grade_level} ${data.section}</p>
                <p class="text-sm text-gray-600">${data.subject}</p>
            </div>
            <div class="text-right">
                <span class="badge-${data.status.toLowerCase()}">${data.status}</span>
                <p class="text-xs text-gray-500 mt-1">${data.timestamp}</p>
            </div>
        </div>
    `;

        recentScans.insertBefore(scanItem, recentScans.firstChild);
    }
</script>
{% endblock %}